version: '3.8'

services:
  # Keycloak service
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    command: start-dev
    env_file:
      - ./configs/keycloak.env
    ports:
      - 8081:8080
    networks:
      - backend

  # Consul service
  consul:
    image: hashicorp/consul:latest
    container_name: consul
    restart: always
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    volumes:
      - consul_data:/consul/data
    ports:
      - "8500:8500"
    command: agent -dev -ui -bind=0.0.0.0 -client=0.0.0.0
    depends_on:
      - keycloak
    networks:
      - backend

  subscription-service:
    image: openjdk:21
    container_name: subscription-service
    volumes:
      - ./backend_services/subscriptionService/build/libs/subscriptionService-1.0.0.jar:/app/service.jar
    command: ["java", "-jar", "/app/service.jar"]
    depends_on:
      - consul
      - api-gateway
    env_file:
      - ./configs/subscription_service.env
    networks:
      - backend

  user-service:
    image: openjdk:21
    container_name: user-service
    volumes:
      - ./backend_services/userService/build/libs/userService-1.0.0.jar:/app/service.jar
    command: ["java", "-jar", "/app/service.jar"]
    depends_on:
      - consul
      - api-gateway
    env_file:
      - ./configs/user_service.env
    networks:
      - backend

  api-gateway:
    image: openjdk:21
    container_name: api-gateway
    volumes:
      - ./api_gateway/build/libs/api_gateway-1.0.0.jar:/app/service.jar
    command: ["java", "-jar", "/app/service.jar"]
    depends_on:
      - consul
    env_file:
      - ./configs/gateway.env
    ports:
      - 8080:8080
    networks:
      - backend

  post-service:
    image: openjdk:21
    container_name: post-service
    volumes:
      - ./backend_services/postService/build/libs/postService-1.0.0.jar:/app/service.jar
    command: ["java", "-jar", "/app/service.jar"]
    depends_on:
      - consul
      - api-gateway
    env_file:
      - ./configs/post_service.env
    networks:
      - backend

  media-service:
    image: openjdk:21
    container_name: media-service
    volumes:
      - ./backend_services/mediaService/build/libs/mediaService-1.0.0.jar:/app/service.jar
    command: [ "java", "-jar", "/app/service.jar" ]
    depends_on:
      - consul
      - api-gateway
    env_file:
      - ./configs/media_service.env
    networks:
      - backend

networks:
  backend:
    driver: bridge

volumes:
  consul_data: